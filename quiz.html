<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Statistics Quiz</title>
    <style>
        /* ---------- Original Styles (unchanged) ---------- */
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        body { display:flex; justify-content:center; align-items:center; min-height:100vh; background:linear-gradient(135deg, #e5e7eb, #d1d5db); font-family:'SF Pro Display', -apple-system, sans-serif; color:#1c2526; overflow-y:auto; position:relative; padding-bottom:clamp(80px,20vw,120px); }
        .glass-bg { position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(120deg,#e5e7eb,#d1d5db,#e5e7eb,#c3cee5); background-size:200% 200%; animation:gradientFlow 15s ease infinite; z-index:0; pointer-events:none; }
        @keyframes gradientFlow { 0%{background-position:0% 0%} 50%{background-position:100% 100%} 100%{background-position:0% 0%} }
        .noise-layer { position:absolute; top:0; left:0; width:100%; height:100%; background:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"%3E%3Cfilter id="noise"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="2" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%" height="100%" filter="url(%23noise)" opacity="0.03"/%3E%3C/svg%3E'); z-index:1; pointer-events:none; }
        .particle-layer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; pointer-events:none; }
        .quiz-container { background:rgba(255,255,255,0.65); padding:clamp(15px,3vw,35px); border-radius:20px; box-shadow:0 8px 32px rgba(0,0,0,0.1), inset 0 1px rgba(255,255,255,0.5); backdrop-filter: blur(10px) saturate(180%); border:1px solid rgba(255,255,255,0.3); width:clamp(260px,90vw,550px); position:relative; z-index:2; animation:slideUp 0.6s ease-out; }
        @keyframes slideUp { 0%{opacity:0; transform:translateY(15px)} 100%{opacity:1; transform:translateY(0)} }
        .quiz-header { text-align:center; margin-bottom:clamp(10px,2.5vw,30px); }
        .quiz-header h1 { font-size:clamp(1.2rem,3vw,2rem); font-weight:600; color:#1c2526; letter-spacing:-0.02em; }
        .quiz-header .score { font-size:clamp(0.8rem,1.8vw,1.1rem); font-weight:400; color:#6b7280; margin-top:4px; }
        .timer { position:absolute; top:clamp(8px,2vw,12px); right:clamp(8px,2vw,12px); font-size:clamp(0.8rem,1.8vw,1.1rem); font-weight:400; color:#ff2d55; background:rgba(255,255,255,0.85); padding:4px 10px; border-radius:12px; backdrop-filter: blur(6px); box-shadow:0 2px 8px rgba(255,45,85,0.15); }
        .question { font-size:clamp(1rem,2.5vw,1.6rem); font-weight:300; margin-bottom:clamp(12px,2.5vw,25px); color:#1c2526; line-height:1.4; text-align:center; }
        .option { display:flex; align-items:center; justify-content:center; padding:clamp(10px,2.5vw,15px); margin:clamp(8px,1.5vw,12px) 0; background:rgba(255,255,255,0.9); border-radius:12px; border:1px solid rgba(255,255,255,0.4); backdrop-filter: blur(8px) saturate(160%); box-shadow:0 4px 12px rgba(0,0,0,0.05); cursor:pointer; font-size:clamp(0.85rem,2vw,1.2rem); font-weight:400; color:#1c2526; transition: all 0.2s ease; min-height:44px; }
        @media (hover: hover){ .option:hover { background: rgba(255,255,255,1); transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,0.08); } }
        .option:active { transform: scale(0.98); }
        .correct { background: rgba(52,199,89,0.15); border-color:#34c759; color:#34c759; box-shadow:0 4px 12px rgba(52,199,89,0.2); }
        .wrong { background: rgba(255,45,85,0.15); border-color:#ff2d55; color:#ff2d55; box-shadow:0 4px 12px rgba(255,45,85,0.2); }
        .disabled { pointer-events:none; opacity:0.5; }
        .quiz-footer { margin-top:clamp(12px,2.5vw,30px); display:flex; justify-content:space-between; align-items:center; font-size:clamp(0.75rem,1.5vw,1rem); color:#6b7280; }
        .btn { padding:clamp(8px,2vw,12px) clamp(15px,3vw,25px); background:#007aff; border-radius:12px; border:none; cursor:pointer; font-size:clamp(0.85rem,2vw,1.1rem); font-weight:600; color:#fff; box-shadow:0 4px 12px rgba(0,122,255,0.2); transition: all 0.2s ease; min-height:44px; }
        @media (hover: hover){ .btn:hover { background:#0066cc; transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,122,255,0.3); } }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background:#d1d5db; color:#6b7280; cursor:not-allowed; box-shadow:none; }
        /* Result Screen with Stunning Animation */
        .result-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100vh; background:rgba(255,255,255,0.75); backdrop-filter: blur(12px) saturate(180%); justify-content:center; align-items:center; flex-direction:column; z-index:2; padding:clamp(15px,3vw,35px); animation:resultScreenFadeIn 1s ease-out forwards; overflow:hidden; }
        @keyframes resultScreenFadeIn { 0%{opacity:0; background:rgba(255,255,255,0)} 100%{opacity:1; background:rgba(255,255,255,0.75)} }
        .result-screen .result-card { background:rgba(255,255,255,0.9); padding:clamp(15px,3vw,30px); border-radius:20px; box-shadow:0 8px 32px rgba(0,0,0,0.1), inset 0 1px rgba(255,255,255,0.5); backdrop-filter: blur(10px); width:clamp(250px,90vw,600px); text-align:center; position:relative; animation:resultCardEntrance 1.2s ease-out forwards; overflow:hidden; }
        @keyframes resultCardEntrance { 0%{ transform:scale(0.5) translateY(100vh); opacity:0; box-shadow:0 0 0 rgba(0,0,0,0); } 60%{ transform:scale(1.1) translateY(-20px); opacity:1; box-shadow:0 20px 40px rgba(0,0,0,0.2); } 100%{ transform:scale(1) translateY(0); opacity:1; box-shadow:0 8px 32px rgba(0,0,0,0.1); } }
        .result-screen h2 { font-size:clamp(1.5rem,3.5vw,2.5rem); font-weight:600; color:#1c2526; margin-bottom:clamp(10px,2.5vw,20px); letter-spacing:-0.02em; animation:textGlow 1.5s ease-in-out infinite alternate; }
        @keyframes textGlow { 0%{ text-shadow:0 0 5px rgba(52,199,89,0.5); } 100%{ text-shadow:0 0 15px rgba(52,199,89,0.8), 0 0 25px rgba(52,199,89,0.4); } }
        .result-screen .result-message { font-size:clamp(0.9rem,2vw,1.4rem); font-weight:400; color:#1c2526; margin-bottom:clamp(15px,3vw,30px); line-height:1.5; white-space:pre-wrap; opacity:0; animation:fadeSlideUp 0.8s ease-out 1.2s forwards; }
        .percentage-bar-container { width:clamp(70%,80vw,400px); background:rgba(255,255,255,0.7); border-radius:10px; padding:4px; margin:0 auto clamp(15px,3vw,30px); box-shadow:0 4px 12px rgba(0,0,0,0.05); opacity:0; animation:fadeSlideUp 0.8s ease-out 1.4s forwards; }
        .percentage-bar { height:16px; background:linear-gradient(90deg,#34c759,#28a745); border-radius:8px; transition: width 1.5s ease-in-out; }
        .breakdown { display:flex; justify-content:space-around; width:clamp(70%,80vw,400px); margin:0 auto clamp(15px,3vw,30px); font-size:clamp(0.8rem,2vw,1.2rem); font-weight:400; color:#6b7280; opacity:0; animation:fadeSlideUp 0.8s ease-out 1.6s forwards; }
        @keyframes fadeSlideUp { 0%{ opacity:0; transform:translateY(20px) } 100%{ opacity:1; transform:translateY(0) } }
        .breakdown .correct { color:#34c759; }
        .breakdown .wrong { color:#ff2d55; }
        .result-screen .btn { background:#34c759; padding:clamp(8px,2vw,14px) clamp(20px,4vw,35px); font-size:clamp(0.9rem,2vw,1.2rem); opacity:0; animation:fadeSlideUp 0.8s ease-out 1.8s forwards; }
        @media (hover: hover){ .result-screen .btn:hover { background:#28a745; box-shadow:0 6px 16px rgba(52,199,89,0.3); } }
        .confetti { position:absolute; width:8px; height:8px; background:linear-gradient(45deg,#34c759,#007aff,#ff2d55); border-radius:50%; z-index:3; pointer-events:none; }
        .result-glow { position:absolute; top:50%; left:50%; width:0; height:0; background:radial-gradient(circle, rgba(52,199,89,0.3), rgba(255,255,255,0)); border-radius:50%; transform:translate(-50%,-50%); animation:glowPulse 2s ease-out infinite; z-index:1; }
        @keyframes glowPulse { 0%{ width:0; height:0; opacity:0 } 50%{ width:400px; height:400px; opacity:0.5 } 100%{ width:600px; height:600px; opacity:0 } }
        .amazing-footer { position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.8); backdrop-filter: blur(12px) saturate(180%); border-top:1px solid rgba(255,255,255,0.3); padding:clamp(10px,2vw,25px); display:flex; justify-content:center; align-items:center; z-index:3; box-shadow:0 -4px 20px rgba(0,0,0,0.1); overflow:hidden; }
        .footer-content { text-align:center; position:relative; z-index:2; }
        .footer-content span { font-size:clamp(0.8rem,1.8vw,1.2rem); font-weight:400; color:#1c2526; margin:0 clamp(5px,1vw,15px); display:inline-block; position:relative; transition: transform 0.3s ease, color 0.3s ease; }
        @media (hover: hover) { .footer-content span:hover { transform: translateY(-3px) scale(1.05); color:#007aff; } .footer-content span::after { content:''; position:absolute; bottom:-5px; left:50%; width:0; height:2px; background:#007aff; transition: width 0.3s ease, left 0.3s ease; } .footer-content span:hover::after { width:100%; left:0; } }
        .footer-bg-effect { position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(45deg, rgba(0,122,255,0.1), rgba(52,199,89,0.1), rgba(255,45,85,0.1)); background-size:300% 300%; animation:footerFlow 10s ease infinite; z-index:1; pointer-events:none; opacity:0.5; }
        @keyframes footerFlow { 0%{background-position:0% 0%} 50%{background-position:100% 100%} 100%{background-position:0% 0%} }
        .footer-particle { position:absolute; width:6px; height:6px; background:rgba(255,255,255,0.6); border-radius:50%; z-index:2; pointer-events:none; }
        @media (max-width:480px) { body { padding-bottom:clamp(100px,25vw,150px); } .quiz-footer { flex-direction:column; gap:10px } .quiz-container { padding:15px; width:clamp(240px,95vw,550px) } .question { font-size:clamp(0.9rem,2.2vw,1.4rem) } .option { padding:12px; margin:8px 0; font-size:clamp(0.8rem,1.8vw,1.1rem) } .btn { padding:10px 20px; font-size:clamp(0.8rem,1.8vw,1rem) } .result-screen .result-card { padding:15px; width:clamp(220px,95vw,600px) } .result-screen h2 { font-size:clamp(1.3rem,3vw,2rem) } .result-screen .result-message { font-size:clamp(0.85rem,1.8vw,1.2rem) } .percentage-bar-container, .breakdown { width:clamp(80%,90vw,400px) } .amazing-footer { padding:10px; flex-direction:column; gap:5px } .footer-content { display:flex; flex-direction:column; align-items:center; gap:5px } .footer-content span { margin:2px 0; font-size:clamp(0.75rem,1.5vw,1rem) } .result-glow { animation:glowPulseMobile 2s ease-out infinite } @keyframes glowPulseMobile { 0%{ width:0; height:0; opacity:0 } 50%{ width:200px; height:200px; opacity:0.5 } 100%{ width:300px; height:300px; opacity:0 } } }
        @media (max-height:500px) { .quiz-container, .result-card { padding:12px } .question { margin-bottom:10px } .quiz-footer { margin-top:10px } .result-screen { padding:12px } .amazing-footer { padding:8px } }
        @media print { body { display:none !important } }
        #screenshot-blocker { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0); z-index:1000; pointer-events:none; transition: background 0.1s; }

        /* ---------- New: Welcome + Admin Editor Styles (keeps glass style) ---------- */
        .overlay {
            position:fixed;
            inset:0;
            display:flex;
            justify-content:center;
            align-items:center;
            z-index:5;
            pointer-events:auto;
        }
        #welcome-screen { width:clamp(300px,85vw,540px); max-width:95vw; }
        .role-row { display:flex; gap:16px; justify-content:space-between; margin-top:10px; }
        .role-btn {
            flex:1;
            display:flex;
            align-items:center;
            gap:12px;
            justify-content:center;
            padding:16px;
            border-radius:14px;
            background:rgba(255,255,255,0.75);
            border:1px solid rgba(255,255,255,0.35);
            box-shadow:0 6px 18px rgba(0,0,0,0.06);
            cursor:pointer;
            transition:transform 0.18s ease, box-shadow 0.18s ease;
            font-weight:600;
            color:#0f1720;
        }
        .role-btn:hover { transform: translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.12); }
        .role-icon {
            width:36px;
            height:36px;
            display:inline-grid;
            place-items:center;
            border-radius:10px;
            background:rgba(255,255,255,0.85);
            box-shadow:0 6px 12px rgba(0,0,0,0.06);
            font-size:18px;
        }
        .small-note { font-size:0.95rem; color:#6b7280; margin-top:8px; text-align:center; }

        /* student form in welcome */
        .field { display:flex; flex-direction:column; gap:6px; margin-top:10px; }
        .field input { padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); outline:none; font-size:1rem; background:rgba(255,255,255,0.9); }
        .field label { font-size:0.9rem; color:#374151; }

        /* admin editor overlay */
        .admin-panel {
            position:fixed;
            right:24px;
            top:24px;
            width:clamp(320px,86vw,760px);
            max-height:calc(100vh - 48px);
            overflow:auto;
            border-radius:16px;
            z-index:6;
            padding:16px;
            background:rgba(255,255,255,0.9);
            box-shadow:0 12px 40px rgba(0,0,0,0.12);
            border:1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            display:none;
            flex-direction:column;
            gap:12px;
        }
        .admin-row { display:flex; gap:10px; align-items:center; }
        .admin-row input[type="text"], .admin-row select { flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); background:rgba(255,255,255,0.95); }
        .admin-controls { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .question-card { padding:10px; border-radius:12px; background:rgba(250,250,250,0.7); border:1px solid rgba(0,0,0,0.03); }
        .admin-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:6px; }

        .small-muted { font-size:0.85rem; color:#6b7280; }
        .danger { background:#ff2d55; color:white; border:none; }
        .success { background:#34c759; color:white; border:none; }

        /* tiny responsive tweaks for admin */
        @media (max-width:720px) { .admin-panel { left:8px; right:8px; top:12px; width:calc(100% - 16px); } .role-row { flex-direction:column; } .role-btn { width:100% } }
    </style>
</head>
<body>
    <div class="glass-bg"></div>
    <div class="noise-layer"></div>
    <div class="particle-layer" id="particle-layer"></div>
    <div id="screenshot-blocker"></div>

    <!-- ---------- Welcome Screen (Student / Admin selection) ---------- -->
    <div class="overlay" id="welcome-overlay">
        <div class="quiz-container" id="welcome-screen" role="dialog" aria-modal="true">
            <div class="quiz-header">
                <h1>Welcome to Statistics Quiz</h1>
                <span class="score small-muted">Choose your role to continue</span>
            </div>

            <div class="role-row">
                <button class="role-btn" id="student-btn" title="Start as student">
                    <div class="role-icon" aria-hidden>
                        <!-- graduation cap SVG -->
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L1 7l11 5 9-4.09V17" stroke="#0f1720" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:700;">Student</div>
                        <div class="small-note">Enter name & roll before starting</div>
                    </div>
                </button>

                <button class="role-btn" id="admin-btn" title="Admin login">
                    <div class="role-icon" aria-hidden>
                        <!-- admin/key SVG -->
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 10v6a2 2 0 0 1-2 2h-6" stroke="#0f1720" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10l5-3 5 3" stroke="#0f1720" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:700;">Admin</div>
                        <div class="small-note">Login to edit questions</div>
                    </div>
                </button>
            </div>

            <!-- Student form (hidden by default) -->
            <div id="student-form" style="display:none; margin-top:12px;">
                <div class="field">
                    <label for="student-name">Full name</label>
                    <input id="student-name" placeholder="e.g. Vicky" />
                </div>
                <div class="field">
                    <label for="student-roll">Roll number</label>
                    <input id="student-roll" placeholder="e.g. 23AI006" />
                </div>
                <div style="display:flex; gap:10px; margin-top:12px;">
                    <button class="btn" id="start-quiz-btn">Start Quiz</button>
                    <button class="btn" id="student-cancel" style="background:#d1d5db; color:#1c2526;">Back</button>
                </div>
            </div>

            <!-- Admin login (hidden by default) -->
            <div id="admin-login" style="display:none; margin-top:12px;">
                <div class="field">
                    <label for="admin-id">Admin ID</label>
                    <input id="admin-id" placeholder="Admin ID" />
                </div>
                <div class="field">
                    <label for="admin-pass">Password</label>
                    <input id="admin-pass" placeholder="Password" type="password" />
                </div>
                <div style="display:flex; gap:10px; margin-top:12px;">
                    <button class="btn" id="admin-login-btn">Login</button>
                    <button class="btn" id="admin-cancel" style="background:#d1d5db; color:#1c2526;">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ---------- Original Quiz Container (kept as-is) ---------- -->
    <div class="quiz-container" id="quiz-container" style="display:none;">
        <div class="timer" id="timer">05:00</div>
        <div class="quiz-header">
            <h1>Statistics Quiz</h1>
            <span class="score">Score: <span id="score">0</span> / 10</span>
        </div>
        <div id="question-container">
            <p class="question" id="question">Loading...</p>
            <div id="options"></div>
        </div>
        <div class="quiz-footer">
            <span id="question-count">1 of 10 Questions</span>
            <button class="btn" id="next-btn" disabled>Next</button>
        </div>
    </div>

    <!-- ---------- Result Screen (updated to show name/roll) ---------- -->
    <div class="result-screen" id="result-screen">
        <div class="result-glow"></div>
        <div class="result-card">
            <h2>Congratulations!</h2>
            <p class="result-message" id="result-message"></p>
            <div class="percentage-bar-container">
                <div class="percentage-bar" id="percentage-bar"></div>
            </div>
            <div class="breakdown">
                <span class="correct">Correct: <span id="correct-count"></span></span>
                <span class="wrong">Wrong: <span id="wrong-count"></span></span>
            </div>
            <button class="btn" id="restart-btn">Try Again</button>
        </div>
    </div>

    <!-- ---------- Admin Editor Panel (overlay) ---------- -->
    <div class="admin-panel" id="admin-panel" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; font-size:1.1rem;">Admin Editor</div>
            <div style="display:flex; gap:8px;">
                <button class="btn" id="admin-save-all">Save All</button>
                <button class="btn" id="admin-close" style="background:#d1d5db; color:#1c2526;">Close</button>
            </div>
        </div>

        <div id="admin-list" style="display:flex; flex-direction:column; gap:10px; margin-top:8px;"></div>

        <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn" id="admin-add">+ Add Question</button>
            <button class="btn success" id="admin-push-firebase" title="Force push to Firebase (if configured)">Push to Firebase</button>
            <button class="btn danger" id="admin-clear-local" title="Clear local saved questions">Clear Local</button>
        </div>

        <div class="small-note small-muted" style="margin-top:8px;">
            Saved to Firebase if configured; otherwise to browser localStorage. Use "Push to Firebase" to force push.
        </div>
    </div>

    <!-- footer removed intentionally in original file; kept commented -->

    <script>
        /* ---------- Data + State ---------- */
        let timer;
        let timeLeft = 300;
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedQuestions = [];
        let studentInfo = { name: '', roll: '' };
        let isAdmin = false;

        // ---------- REPLACED: removed hardcoded allQuestions array ----------
        // Use Firestore as the source of truth. Keep an in-memory array for admin editing and local fallback.
        let allQuestions = [];

        /* ---------- Persistence: Firebase (optional) + localStorage fallback ---------- */

        // ✅ Inserted your real Firebase config:
        const firebaseConfig = {
            apiKey: "AIzaSyCjz2tUwuit8amZeyb2B6YBE4qZkiy-xTA",
            authDomain: "quiz-app-572e8.firebaseapp.com",
            projectId: "quiz-app-572e8",
            storageBucket: "quiz-app-572e8.firebasestorage.app",
            messagingSenderId: "295740833345",
            appId: "1:295740833345:web:2cc7639dac6c313e9890c0",
            measurementId: "G-E1Z33LQBWY"
        };

        let firestoreDB = null;
        let firebaseEnabled = false;

        async function tryInitFirebase() {
            // Initialize only if config is set
            try {
                if (firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5) {
                    // load firebase modules dynamically (CDN)
                    const appModule = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                    const firestoreModule = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                    const app = appModule.initializeApp(firebaseConfig);
                    firestoreDB = firestoreModule.getFirestore(app);
                    firebaseEnabled = true;
                    console.log('Firebase initialized.');
                    await loadQuestionsFromFirestore(); // try to load
                } else {
                    console.log('Firebase config not provided — using localStorage fallback.');
                    loadQuestionsFromLocal();
                }
            } catch (err) {
                console.error('Firebase init failed:', err);
                loadQuestionsFromLocal();
            }
        }

        // Firestore helpers (if enabled)
        async function loadQuestionsFromFirestore() {
            if (!firebaseEnabled) return;
            try {
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                const qSnap = await getDocs(collection(firestoreDB, 'questions'));
                const arr = [];
                qSnap.forEach(d => {
                    const data = d.data();
                    // Normalise shape if necessary
                    if (data.question && Array.isArray(data.options) && data.answer) {
                        arr.push({ question: data.question, options: data.options, answer: data.answer, _id: d.id });
                    }
                });
                if (arr.length > 0) {
                    allQuestions = arr.map(a => ({ question: a.question, options: a.options, answer: a.answer }));
                    saveQuestionsToLocal(); // keep local copy
                    console.log('Loaded questions from Firestore:', allQuestions.length);
                } else {
                    console.log('No questions in Firestore — using defaults/local copy.');
                    loadQuestionsFromLocal();
                }
            } catch (err) {
                console.error('Error loading from Firestore:', err);
                loadQuestionsFromLocal();
            }
        }

        async function pushAllToFirestore() {
            if (!firebaseEnabled) { alert('Firebase not configured. Paste config to enable.'); return; }
            try {
                const { collection, addDoc, getDocs, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                const colRef = collection(firestoreDB, 'questions');
                // Clear existing docs (simple approach)
                const existing = await getDocs(colRef);
                for (const d of existing.docs) {
                    await deleteDoc(doc(firestoreDB, 'questions', d.id));
                }
                // Add current array
                for (const q of allQuestions) {
                    await addDoc(colRef, { question: q.question, options: q.options, answer: q.answer });
                }
                alert('Pushed questions to Firestore successfully.');
            } catch (err) {
                console.error(err);
                alert('Failed to push to Firestore. See console.');
            }
        }

        // Local storage helpers
        const LOCAL_KEY = 'quiz_questions_v1';
        function saveQuestionsToLocal() {
            try {
                localStorage.setItem(LOCAL_KEY, JSON.stringify(allQuestions));
            } catch (e) { console.warn('local save failed', e); }
        }
        function loadQuestionsFromLocal() {
            try {
                const raw = localStorage.getItem(LOCAL_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        allQuestions = parsed;
                        console.log('Loaded questions from localStorage');
                        return;
                    }
                }
            } catch (e) { console.warn(e); }
            // otherwise allQuestions stays empty
        }
        function clearLocalQuestions() {
            localStorage.removeItem(LOCAL_KEY);
            location.reload();
        }

        /* ---------- Quiz logic (mostly unchanged) ---------- */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectRandomQuestions() {
            const shuffled = shuffleArray([...allQuestions]);
            return shuffled.slice(0, 10).map(q => {
                return { ...q, options: shuffleArray([...q.options]) };
            });
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endQuiz();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function endQuiz() {
            clearInterval(timer);
            document.getElementById("next-btn").disabled = true;
            document.querySelectorAll(".option").forEach(option => option.classList.add("disabled"));
            showResult();
        }

        function loadQuestion() {
            let currentQuestion = selectedQuestions[currentQuestionIndex];
            document.getElementById("question").innerText = currentQuestion.question;
            document.getElementById("options").innerHTML = "";

            const correctAnswer = currentQuestion.answer;
            currentQuestion.options.forEach(opt => {
                let btn = document.createElement("div");
                btn.innerText = opt;
                btn.classList.add("option");
                btn.onclick = () => checkAnswer(opt, btn, correctAnswer);
                document.getElementById("options").appendChild(btn);
            });

            document.getElementById("question-count").innerText = `${currentQuestionIndex + 1} of ${selectedQuestions.length} Questions`;
        }

        function checkAnswer(selectedOption, btn, correctAnswer) {
            document.querySelectorAll(".option").forEach(option => option.classList.add("disabled"));
            if (selectedOption === correctAnswer) {
                btn.classList.add("correct");
                score++;
            } else {
                btn.classList.add("wrong");
                document.querySelectorAll(".option").forEach(option => {
                    if (option.innerText === correctAnswer) {
                        option.classList.add("correct");
                    }
                });
            }
            document.getElementById("score").innerText = score;
            document.getElementById("next-btn").disabled = false;
        }

        function animateText(element, text, delay = 50) {
            element.innerText = "";
            let index = 0;
            const interval = setInterval(() => {
                if (index < text.length) {
                    element.innerText += text[index];
                    index++;
                } else {
                    clearInterval(interval);
                }
            }, delay);
        }

        function createConfetti() {
            const confetti = document.createElement("div");
            confetti.classList.add("confetti");
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.top = `${Math.random() * -20 - 10}vh`;
            document.getElementById("result-screen").appendChild(confetti);

            const duration = Math.random() * 2 + 2;
            const xMove = (Math.random() - 0.5) * 200;
            const rotation = Math.random() * 720 - 360;

            confetti.animate([
                { transform: `translate(${xMove}px, 120vh) rotate(${rotation}deg)`, opacity: 1 },
                { opacity: 0, offset: 0.9 }
            ], {
                duration: duration * 1000,
                easing: "ease-out",
                fill: "forwards"
            }).onfinish = () => confetti.remove();
        }

        function startConfettiAnimation() {
            for (let i = 0; i < 30; i++) {
                setTimeout(createConfetti, i * 100);
            }
        }

        function showResult() {
            document.getElementById("quiz-container").style.display = "none";
            const resultScreen = document.getElementById("result-screen");
            resultScreen.style.display = "flex";

            const totalQuestions = selectedQuestions.length;
            const correctCount = score;
            const wrongCount = totalQuestions - score;
            const percentage = (score / totalQuestions) * 100;

            const namePart = studentInfo.name ? `\n\nStudent: ${studentInfo.name}` : '';
            const rollPart = studentInfo.roll ? `\nRoll No: ${studentInfo.roll}` : '';
            const resultMessageText = `You scored ${score} out of ${totalQuestions}!${namePart}${rollPart}\n\n🎉 Congratulations!`;

            const resultMessage = document.getElementById("result-message");
            animateText(resultMessage, resultMessageText, 30);

            document.getElementById("correct-count").innerText = correctCount;
            document.getElementById("wrong-count").innerText = wrongCount;
            const percentageBar = document.getElementById("percentage-bar");
            percentageBar.style.width = "0%";
            setTimeout(() => {
                percentageBar.style.width = `${percentage}%`;
            }, 2000);

            startConfettiAnimation();
        }

        function createParticle() {
            const particle = document.createElement("div");
            const size = Math.random() * 6 + 2;
            particle.style.position = "absolute";
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.background = `rgba(255,255,255,${Math.random() * 0.3 + 0.1})`;
            particle.style.borderRadius = "50%";
            particle.style.boxShadow = `0 0 ${size * 2}px rgba(255,255,255,0.5)`;
            particle.style.left = `${Math.random() * 100}vw`;
            particle.style.top = `${Math.random() * 100}vh`;
            document.getElementById("particle-layer").appendChild(particle);

            const duration = Math.random() * 5 + 5;
            const xMove = (Math.random() - 0.5) * 50;
            const yMove = (Math.random() - 0.5) * 50;

            particle.animate([
                { transform: "translate(0, 0)", opacity: 0 },
                { transform: `translate(${xMove}px, ${yMove}px)`, opacity: 1, offset: 0.2 },
                { transform: `translate(${xMove * 1.5}px, ${yMove * 1.5}px)`, opacity: 0 }
            ], {
                duration: duration * 1000,
                easing: "ease-in-out",
                fill: "forwards"
            }).onfinish = () => particle.remove();
        }

        function startParticleAnimation() {
            setInterval(() => {
                if (Math.random() > (window.innerWidth < 480 ? 0.85 : 0.7)) createParticle();
            }, 500);
        }

        function createFooterParticle() {
            const particle = document.createElement("div");
            particle.classList.add("footer-particle");
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.bottom = "0";
            const footer = document.querySelector(".amazing-footer");
            if (footer) {
                footer.appendChild(particle);
                const duration = Math.random() * 3 + 2;
                particle.animate([
                    { transform: "translateY(0)", opacity: 1 },
                    { transform: `translateY(-${Math.random() * 50 + 20}px)`, opacity: 0 }
                ], {
                    duration: duration * 1000,
                    easing: "ease-out",
                    fill: "forwards"
                }).onfinish = () => particle.remove();
            }
        }

        function startFooterParticleAnimation() {
            setInterval(() => {
                if (Math.random() > (window.innerWidth < 480 ? 0.9 : 0.8)) createFooterParticle();
            }, 300);
        }

        function startQuiz() {
            selectedQuestions = selectRandomQuestions();
            loadQuestion();
            startTimer();
            startParticleAnimation();
            startFooterParticleAnimation();
        }

        function resetQuiz() {
            clearInterval(timer);
            timeLeft = 300;
            currentQuestionIndex = 0;
            score = 0;
            document.getElementById("score").innerText = "0";
            document.getElementById("timer").textContent = "05:00";
            document.getElementById("particle-layer").innerHTML = "";
            document.getElementById("result-screen").style.display = "none";
            document.getElementById("quiz-container").style.display = "block";
            startQuiz();
        }

        /* ---------- Event wiring (welcome screen & admin) ---------- */
        document.getElementById('student-btn').addEventListener('click', () => {
            document.getElementById('student-form').style.display = 'block';
            document.getElementById('admin-login').style.display = 'none';
        });
        document.getElementById('admin-btn').addEventListener('click', () => {
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('student-form').style.display = 'none';
        });

        document.getElementById('student-cancel').addEventListener('click', () => {
            document.getElementById('student-form').style.display = 'none';
        });

        document.getElementById('admin-cancel').addEventListener('click', () => {
            document.getElementById('admin-login').style.display = 'none';
        });

        document.getElementById('start-quiz-btn').addEventListener('click', () => {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            if (!name || !roll) {
                alert('Please enter name and roll number.');
                return;
            }
            studentInfo = { name, roll };
            // hide welcome and start
            document.getElementById('welcome-overlay').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            startQuiz();
        });

        document.getElementById('admin-login-btn').addEventListener('click', () => {
            const id = document.getElementById('admin-id').value.trim();
            const pass = document.getElementById('admin-pass').value;
            if (id === 'Vicky' && pass === 'Vicky2005') {
                isAdmin = true;
                document.getElementById('welcome-overlay').style.display = 'none';
                openAdminPanel();
            } else {
                alert('Invalid admin credentials.');
            }
        });

        /* ---------- Next / Restart handlers ---------- */
        document.getElementById("next-btn").addEventListener("click", () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < selectedQuestions.length) {
                loadQuestion();
                document.getElementById("next-btn").disabled = true;
            } else {
                endQuiz();
            }
        });

        document.getElementById("restart-btn").addEventListener("click", () => {
            // Show welcome again for fresh student info, unless admin requested quiz restart
            if (isAdmin) {
                // admin triggered restart: just reset quiz
                resetQuiz();
            } else {
                // show welcome overlay to ask for student details again
                document.getElementById('welcome-overlay').style.display = 'flex';
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('result-screen').style.display = 'none';
            }
        });

        /* ---------- Admin Editor functionality (local + optional Firestore) ---------- */

        const adminPanelEl = document.getElementById('admin-panel');
        function openAdminPanel() {
            adminPanelEl.style.display = 'flex';
            adminPanelEl.setAttribute('aria-hidden', 'false');
            renderAdminList();
        }
        document.getElementById('admin-close').addEventListener('click', () => {
            adminPanelEl.style.display = 'none';
            adminPanelEl.setAttribute('aria-hidden', 'true');
            // return to welcome overlay so admin can start quiz if wanted
            document.getElementById('welcome-overlay').style.display = 'flex';
        });

        function renderAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = '';
            allQuestions.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div style="font-weight:600;">Q${idx+1}</div>
                        <input type="text" class="admin-qtext" data-idx="${idx}" value="${escapeHtml(q.question)}" />
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input type="text" class="admin-opt" data-idx="${idx}" data-opt="0" value="${escapeHtml(q.options[0]||'')}" />
                        <input type="text" class="admin-opt" data-idx="${idx}" data-opt="1" value="${escapeHtml(q.options[1]||'')}" />
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input type="text" class="admin-opt" data-idx="${idx}" data-opt="2" value="${escapeHtml(q.options[2]||'')}" />
                        <input type="text" class="admin-opt" data-idx="${idx}" data-opt="3" value="${escapeHtml(q.options[3]||'')}" />
                    </div>
                    <div class="admin-row" style="margin-top:8px;">
                        <select class="admin-answer" data-idx="${idx}">
                            <option value="">Select correct answer</option>
                            <option value="0">${escapeHtml(q.options[0]||'')}</option>
                            <option value="1">${escapeHtml(q.options[1]||'')}</option>
                            <option value="2">${escapeHtml(q.options[2]||'')}</option>
                            <option value="3">${escapeHtml(q.options[3]||'')}</option>
                        </select>
                        <div style="flex:1;"></div>
                        <button class="btn" data-del="${idx}" title="Delete question" style="background:#ffb6c1;color:#1c2526;">Delete</button>
                    </div>
                `;
                list.appendChild(card);
                // set selected answer index
                const sel = card.querySelector('.admin-answer');
                const answerIndex = q.options.findIndex(o => o === q.answer);
                if (answerIndex >= 0) sel.value = String(answerIndex);
            });

            // wire up input listeners
            list.querySelectorAll('.admin-qtext').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const idx = Number(e.target.dataset.idx);
                    allQuestions[idx].question = e.target.value;
                    saveQuestionsToLocal();
                });
            });
            list.querySelectorAll('.admin-opt').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const idx = Number(e.target.dataset.idx);
                    const o = Number(e.target.dataset.opt);
                    allQuestions[idx].options[o] = e.target.value;
                    saveQuestionsToLocal();
                });
            });
            list.querySelectorAll('.admin-answer').forEach(sel => {
                sel.addEventListener('change', (e) => {
                    const idx = Number(e.target.dataset.idx);
                    const chosen = Number(e.target.value);
                    if (!isNaN(chosen)) {
                        allQuestions[idx].answer = allQuestions[idx].options[chosen] || '';
                        saveQuestionsToLocal();
                    }
                });
            });
            list.querySelectorAll('[data-del]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = Number(e.target.getAttribute('data-del'));
                    if (confirm('Delete this question?')) {
                        allQuestions.splice(idx, 1);
                        saveQuestionsToLocal();
                        renderAdminList();
                    }
                });
            });
        }

        document.getElementById('admin-add').addEventListener('click', () => {
            allQuestions.push({
                question: 'New question?',
                options: ['Option 1','Option 2','Option 3','Option 4'],
                answer: 'Option 1'
            });
            saveQuestionsToLocal();
            renderAdminList();
        });

        document.getElementById('admin-save-all').addEventListener('click', () => {
            // When save all clicked, ensure any selects map to answers
            document.querySelectorAll('.admin-answer').forEach(sel => {
                const idx = Number(sel.dataset.idx);
                const chosen = Number(sel.value);
                if (!isNaN(chosen)) allQuestions[idx].answer = allQuestions[idx].options[chosen] || '';
            });
            saveQuestionsToLocal();
            alert('Saved locally.');
        });

        document.getElementById('admin-push-firebase').addEventListener('click', async () => {
            if (!firebaseEnabled) {
                alert('Firebase not configured. Paste config in the source to enable push.');
                return;
            }
            await pushAllToFirestore();
        });

        document.getElementById('admin-clear-local').addEventListener('click', () => {
            if (confirm('Clear saved local questions and reload?')) clearLocalQuestions();
        });

        /* ---------- Helpers ---------- */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
        }

        /* ---------- Init on load ---------- */
        window.onload = async () => {
            // attempt to init firebase and load persisted questions
            await tryInitFirebase();
            // if Firebase didn't override questions, local load will happen in tryInitFirebase
            // show welcome overlay on load (default)
            document.getElementById('welcome-overlay').style.display = 'flex';
            // quiz container hidden until student/admin chooses action
        };

        /* ---------- Anti-copy / screenshot / visibility handlers (kept from original) ---------- */
        document.addEventListener("copy", (e) => {
            if (document.getElementById("quiz-container").style.display === "block") {
                e.preventDefault();
                alert("Copying is not allowed! Reloading...");
                location.reload();
            }
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "PrintScreen" || (e.ctrlKey && e.key === "p")) {
                document.getElementById("screenshot-blocker").style.background = "black";
                setTimeout(() => {
                    document.getElementById("screenshot-blocker").style.background = "rgba(0, 0, 0, 0)";
                }, 100);
            }
        });

        document.addEventListener("contextmenu", (e) => {
            if (document.getElementById("quiz-container").style.display === "block") {
                e.preventDefault();
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (document.hidden && document.getElementById("quiz-container").style.display === "block") {
                alert("You switched apps! The quiz will restart.");
                resetQuiz();
            }
        });
    </script>
</body>
</html>

